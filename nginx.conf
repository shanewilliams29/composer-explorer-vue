# /etc/nginx/conf.d/composerexplorer.conf
#
# 1) Plain-HTTP vhost → force HTTPS
server {
    listen 80;
    server_name composerexplorer.com;
    return 301 https://$host$request_uri;
}

# 2) HTTPS vhost
server {
    listen 443 ssl;              # removed “http2” here
    http2  on;                   # new syntax

    server_name composerexplorer.com;

    ssl_certificate     /etc/letsencrypt/live/composerexplorer.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/composerexplorer.com/privkey.pem;

    # --- Security headers ---
    add_header X-Frame-Options           "SAMEORIGIN";
    add_header X-Content-Type-Options    "nosniff";
    add_header X-XSS-Protection          "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # --- Logs ---
    access_log  /var/log/composerexplorer_access.log;
    error_log   /var/log/composerexplorer_error.log;

    # --- Static root (built Vue app) ---
    # All files produced by `npm run build` live here
    root /home/shane/Production/composer-explorer-vue/server/dist;

    ########################################
    #  A. Serve hashed assets / images / fonts directly
    ########################################
    location ~* \.(?:js|css|woff2?|png|jpe?g|gif|svg|ico)$ {
        access_log off;
        expires 1y;                               # cache forever (names are content-hashed)
        add_header Cache-Control "public, immutable";
        try_files $uri =404;                      # don’t bother Gunicorn
    }

    ########################################
    #  B. Backend API — **and only the API** — hits Gunicorn
    ########################################
    location /api/ {
        proxy_pass http://127.0.0.1:8000;   # << change made here
        proxy_set_header Host            $host;
        proxy_set_header X-Real-IP       $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 30s;
    }

    ########################################
    #  C. Server-rendered Gunicorn pages
    ########################################
    location /testlogin      { proxy_pass http://127.0.0.1:8000; include proxy_params; }
    location /connect_spotify       { proxy_pass http://127.0.0.1:8000; include proxy_params; }
    location /login    { proxy_pass http://127.0.0.1:8000; include proxy_params; }\
    location /log_out    { proxy_pass http://127.0.0.1:8000; include proxy_params; }\
    location /disable_patreon_link    { proxy_pass http://127.0.0.1:8000; include proxy_params; }\
    location /change_avatar    { proxy_pass http://127.0.0.1:8000; include proxy_params; }\
    location /change_display_name    { proxy_pass http://127.0.0.1:8000; include proxy_params; }\
    location /spotify    { proxy_pass http://127.0.0.1:8000; include proxy_params; }\
    location /privacy    { proxy_pass http://127.0.0.1:8000; include proxy_params; }\
    location /user_list    { proxy_pass http://127.0.0.1:8000; include proxy_params; }\

    ########################################
    #  D. History-mode fallback for SPA
    ########################################
    location / {
        # 1. If the exact file exists, serve it (index.html, robots.txt …)
        # 2. Otherwise send index.html (Vue router in history mode)
        try_files $uri $uri/ /index.html;
    }

    # Optional: if you’ve pre-compressed *.gz / *.br assets
    #gzip_static  on;
    #brotli_static on;
}
